# Cleanup & Rebuild Script Created ‚úÖ

**Date**: 2025-12-06  
**Script**: `scripts/cleanup-rebuild-platform.sh`

## What Was Created

A comprehensive platform cleanup and rebuild script that matches the style of `start-platform.sh` with three cleanup levels and multiple options.

### Features

1. **Three Cleanup Levels**:
   - üü¢ **Light** (default) - Stop containers only
   - üü° **Medium** - Remove containers, keep volumes
   - üî¥ **Deep** - Remove everything including volumes (DESTRUCTIVE)

2. **Options**:
   - `--rebuild` - Rebuild images after cleanup
   - `--restart` - Restart platform after cleanup
   - `--skip-confirm` - Skip confirmation prompts

3. **Safety Features**:
   - Confirmation required for destructive operations
   - Clear warnings with color coding
   - Lists volumes before deletion
   - Stops services in reverse dependency order

4. **User Experience**:
   - Color-coded output (red/yellow/green/blue)
   - Progress indicators with arrows (‚Üí)
   - Clear section headers
   - Helpful summary at the end

## Usage Examples

### Most Common: After Code Changes
```bash
# Stop, clean up, rebuild images, restart
./scripts/cleanup-rebuild-platform.sh --medium --rebuild --restart
```

**What it does:**
1. Stops all containers
2. Removes stopped containers
3. Cleans up unused networks and images
4. **Keeps** all volumes (databases, logs, etc.)
5. Rebuilds hlidskjalf-api, hlidskjalf-ui, and langgraph
6. Restarts the platform

**Time:** ~2-3 minutes depending on build cache

---

### Quick Restart
```bash
# Just stop and restart
./scripts/cleanup-rebuild-platform.sh --light --restart
```

**What it does:**
1. Stops all containers
2. Restarts them

**Time:** ~30 seconds

---

### Fresh Start (Nuclear Option)
```bash
# Complete reset - REMOVES ALL DATA
./scripts/cleanup-rebuild-platform.sh --deep --rebuild --restart
```

**What it does:**
1. Stops all containers
2. Removes containers, networks, images
3. **REMOVES ALL VOLUMES** (Postgres, Redis, GitLab, Grafana, etc.)
4. Clears builder cache
5. Rebuilds all images from scratch
6. Restarts platform

**‚ö†Ô∏è WARNING:** This deletes:
- All PostgreSQL databases
- All Redis cache/state
- All GitLab repositories and configuration
- All Grafana dashboards
- All observability data (Prometheus, Loki, Tempo)
- All Ollama models (multi-gigabyte downloads)

**Requires confirmation:** Type "yes" to proceed

**Time:** ~10-15 minutes depending on network speed

---

### Just Cleanup (No Restart)
```bash
# Clean up but don't restart (for manual control)
./scripts/cleanup-rebuild-platform.sh --medium
```

**Then manually start what you need:**
```bash
docker compose --env-file .env -f compose/docker-compose.infrastructure.yml up -d
docker compose --env-file .env -f compose/docker-compose.langgraph.yml up -d
```

---

## Script Structure

The script follows the same conventions as `start-platform.sh`:

```bash
#!/usr/bin/env bash
set -euo pipefail

# 1. Parse arguments
# 2. Show configuration
# 3. Confirm destructive operations

# STEP 1: Stop All Services (reverse order)
# STEP 2: Cleanup Resources (based on level)
# STEP 3: Rebuild Images (optional)
# STEP 4: Restart Platform (optional)

# Summary
```

### Color Coding
- üî¥ **RED** - Warnings, destructive operations
- üü° **YELLOW** - Important info, values
- üü¢ **GREEN** - Success messages
- üîµ **BLUE** - Progress indicators

### Error Handling
- `set -euo pipefail` - Exit on errors
- `|| true` for optional cleanup steps
- Graceful failure for missing compose files

---

## Files Created

1. **`scripts/cleanup-rebuild-platform.sh`** (executable)
   - Main script with full functionality
   - 300+ lines with comprehensive features

2. **`docs/CLEANUP_REBUILD_GUIDE.md`**
   - Complete user guide
   - Common scenarios
   - Troubleshooting section
   - Best practices

3. **`docs/wiki/Operations.md`** (updated)
   - Added cleanup commands to Quick Start
   - Reference to the guide

---

## Example Output

```bash
$ ./scripts/cleanup-rebuild-platform.sh --medium --rebuild --restart

=========================================
Ravenhelm Platform - Cleanup & Rebuild
=========================================

Cleanup Level: medium
Rebuild Images: true
Restart After: true

=========================================
STEP 1: Stopping All Services
=========================================

‚Üí Stopping compose/docker-compose.integrations.yml...
‚Üí Stopping compose/docker-compose.gitlab.yml...
‚Üí Stopping compose/docker-compose.langgraph.yml...
‚Üí Stopping compose/docker-compose.events.yml...
‚Üí Stopping compose/docker-compose.observability.yml...
‚Üí Stopping compose/docker-compose.ai-infra.yml...
‚Üí Stopping compose/docker-compose.security.yml...
‚Üí Stopping compose/docker-compose.infrastructure.yml...
‚úì All services stopped

=========================================
STEP 2: Cleanup Resources
=========================================

‚Üí Removing stopped containers...
‚úì Containers removed

‚Üí Removing unused networks...
‚úì Networks cleaned

‚Üí Removing dangling images...
‚úì Dangling images removed

=========================================
STEP 3: Rebuilding Platform Images
=========================================

‚Üí Building hlidskjalf-api...
‚úì hlidskjalf-api built

‚Üí Building hlidskjalf-ui...
‚úì hlidskjalf-ui built

‚Üí Building langgraph (Norns)...
‚úì langgraph built

‚Üí Building other services...
‚úì All images rebuilt

=========================================
STEP 4: Restarting Platform
=========================================

‚Üí Running start-platform.sh...

=========================================
Ravenhelm Platform - Full Stack Startup
=========================================

‚Üí Creating platform networks...
‚Üí Starting Infrastructure Stack...
‚Üí Starting Security Stack...
‚Üí Waiting for infrastructure to be healthy...
‚Üí Starting AI Infrastructure...
‚Üí Starting Observability Stack...
‚Üí Starting Events Stack...
‚Üí Starting LangGraph & Hlidskjalf...
‚Üí Starting GitLab Stack...
‚Üí Starting Integrations...

=========================================
‚úÖ Platform Started Successfully!
=========================================

Key Services:
  ‚Ä¢ Hlidskjalf UI:     https://hlidskjalf.ravenhelm.test
  ‚Ä¢ Norns (LangGraph): https://norns.ravenhelm.test
  ‚Ä¢ GitLab:            https://gitlab.ravenhelm.test
  ‚Ä¢ Grafana:           https://grafana.observe.ravenhelm.test
  ‚Ä¢ Zitadel:           https://zitadel.ravenhelm.test

=========================================
‚úÖ Cleanup Complete!
=========================================

Summary:
  ‚Ä¢ Cleanup Level: medium
  ‚Ä¢ Images Rebuilt: true
  ‚Ä¢ Platform Restarted: true

Platform is now running. Check status with:
  docker compose ps

Done! üéâ
```

---

## Testing

The script has been:
- ‚úÖ Created and made executable
- ‚úÖ Structured with proper error handling
- ‚úÖ Documented in detailed guide
- ‚úÖ Added to Operations wiki
- ‚è≥ **Ready to test**

### Test Sequence

```bash
# 1. Test light cleanup (safest)
./scripts/cleanup-rebuild-platform.sh --light --restart

# 2. Test medium cleanup without rebuild
./scripts/cleanup-rebuild-platform.sh --medium

# 3. Test medium with rebuild (full workflow)
./scripts/cleanup-rebuild-platform.sh --medium --rebuild --restart

# 4. Test deep cleanup confirmation prompt
./scripts/cleanup-rebuild-platform.sh --deep
# (should ask for confirmation)

# 5. Test with skip-confirm (automation scenario)
./scripts/cleanup-rebuild-platform.sh --deep --skip-confirm --restart
# (be careful - this will delete everything!)
```

---

## Integration Points

### Works With
- `./scripts/start-platform.sh` - Called automatically with `--restart`
- `./scripts/create_traefik_networks.sh` - Called before restart
- All compose files in `compose/` directory
- Main `docker-compose.yml` if present

### Related Scripts
- `./scripts/start-platform.sh` - Start services
- `./scripts/start-dev.sh` - Start minimal stack
- `./scripts/backup-to-s3.sh` - Backup before deep cleanup
- `./scripts/init-platform.sh` - Initialize after deep cleanup

---

## Best Practices

### Development Workflow
```bash
# 1. Make code changes
git pull origin main

# 2. Cleanup and rebuild
./scripts/cleanup-rebuild-platform.sh --medium --rebuild --restart

# 3. Test changes
open https://hlidskjalf.ravenhelm.test
```

### Before Major Changes
```bash
# 1. Backup first (if available)
./scripts/backup-to-s3.sh

# 2. Deep cleanup
./scripts/cleanup-rebuild-platform.sh --deep --rebuild --restart

# 3. Re-initialize if needed
./scripts/init-platform.sh
```

### Weekly Maintenance
```bash
# Clean up cruft
./scripts/cleanup-rebuild-platform.sh --medium

# Check disk usage
docker system df
```

---

## Next Steps

The script is ready to use! Common commands:

```bash
# After pulling code changes (MOST COMMON)
./scripts/cleanup-rebuild-platform.sh --medium --rebuild --restart

# Quick restart
./scripts/cleanup-rebuild-platform.sh --light --restart

# Complete reset (careful!)
./scripts/cleanup-rebuild-platform.sh --deep --rebuild --restart
```

For detailed information, see:
- `docs/CLEANUP_REBUILD_GUIDE.md` - Complete guide with scenarios
- `docs/wiki/Operations.md` - Quick reference
- Script itself has inline comments for maintainers

