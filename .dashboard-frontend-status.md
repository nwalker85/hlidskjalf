# Dashboard Frontend Status

**Date:** 2025-12-06  
**Status:** ✅ **DEPLOYED & READY**

## Summary

The Hlidskjalf UI has been successfully rebuilt with all the new dashboard features:
- ✅ OpenTelemetry instrumentation installed
- ✅ Real-time data integration with React Query
- ✅ Telemetry initialization on app load
- ✅ Container rebuilt and restarted
- ✅ Application ready and serving

## What Changed

### 1. Dependencies Added
- `@opentelemetry/api` - Core OpenTelemetry API
- `@opentelemetry/sdk-trace-web` - Browser tracing
- `@opentelemetry/instrumentation-fetch` - Automatic fetch instrumentation
- `@opentelemetry/instrumentation-document-load` - Page load tracking
- `@opentelemetry/exporter-trace-otlp-http` - Export to Grafana Alloy
- `@opentelemetry/sdk-metrics` - Metrics collection
- `@opentelemetry/exporter-metrics-otlp-http` - Metrics export

### 2. New Files Created
- `hlidskjalf/ui/src/lib/telemetry.ts` - OpenTelemetry configuration
- `hlidskjalf/ui/src/app/telemetry-init.tsx` - Client-side initializer

### 3. Modified Files
- `hlidskjalf/ui/src/app/page.tsx` - Replaced mock data with React Query
- `hlidskjalf/ui/src/app/layout.tsx` - Added telemetry initializer
- `hlidskjalf/ui/src/lib/api.ts` - Added new API methods
- `hlidskjalf/ui/package.json` - Added OpenTelemetry dependencies

## Current Status

### Frontend Application
- **URL (Dev):** https://hlidskjalf.ravenhelm.test
- **URL (Staging):** https://hlidskjalf.ravenhelm.dev
- **Status:** ✅ Running (Ready in 34ms)
- **Container:** gitlab-sre-hlidskjalf-ui
- **Port:** 3900

### Backend API
- **URL:** https://hlidskjalf-api.ravenhelm.test
- **Status:** ✅ Healthy
- **Container:** gitlab-sre-hlidskjalf
- **Port:** 8900

### Features Now Active

#### 1. Real-Time Stats Cards
```typescript
const { data: stats } = useQuery({
  queryKey: ['platform-overview'],
  queryFn: () => api.getOverview(),
  refetchInterval: 10000, // Auto-refresh every 10 seconds
});
```

Shows:
- Total projects (from database)
- Total deployments
- Ports allocated
- Healthy deployments
- Unhealthy deployments

#### 2. Real Projects Table
```typescript
const { data: projects } = useQuery({
  queryKey: ['projects', selectedRealm],
  queryFn: () => api.listProjects(selectedRealm || undefined),
  refetchInterval: 15000, // Auto-refresh every 15 seconds
});
```

Shows:
- Project name and ID
- Realm (environment)
- Service count
- Health status
- Manage link

#### 3. OpenTelemetry Instrumentation
```typescript
// Automatically initialized on app load
initTelemetry();
```

Tracks:
- All fetch() API calls
- Page load times
- Document load events
- Custom spans (via `withTrace()` helper)

Exports to:
- Grafana Alloy at `http://alloy.ravenhelm.test:4318`
- Visible in Grafana dashboard at `/d/hlidskjalf-frontend`

#### 4. Observability Widget
- SSE stream from `/api/norns/observability/stream`
- Real-time events from Redpanda
- Event counts and summaries
- Live status indicator

## Known Transient Errors (Normal)

These errors appear during startup and are expected:

```
LLM config API error: TypeError: fetch failed
LLM providers API error: TypeError: fetch failed
Observability stream error: [Error: Failed to connect to observability stream]
```

**Why:** The UI tries to connect to backend APIs during build/startup before all services are fully ready. These resolve automatically once everything is running.

## How to Access

### 1. Development Environment (.test)
```bash
# Open in browser
open https://hlidskjalf.ravenhelm.test

# You'll be redirected to Zitadel login
# After login, you'll see the dashboard with real data
```

### 2. Staging Environment (.dev)
```bash
# Open in browser
open https://hlidskjalf.ravenhelm.dev

# Same SSO flow, but with Let's Encrypt certificates
```

### 3. Grafana Performance Dashboard
```bash
# Development
open https://grafana.ravenhelm.test/d/hlidskjalf-frontend

# Staging
open https://grafana.ravenhelm.dev/d/hlidskjalf-frontend
```

## What You Should See

### Dashboard Homepage
1. **Header**
   - Hliðskjálf logo with animation
   - Huginn & Muninn status indicators
   - LLM Settings button
   - New Project button
   - Meet the Norns link

2. **Stats Cards (Top Row)**
   - Projects: Real count from database
   - Deployments: Real count
   - Ports Allocated: Real count
   - Healthy: Real count (green)
   - Unhealthy: Real count (red)

3. **Observability Stream**
   - Live events from Redpanda
   - Event counts by type
   - Recent events with timestamps
   - Connection status indicator

4. **Nine Realms Grid**
   - 9 realm cards (Midgard, Alfheim, Asgard, etc.)
   - Status badges (active, idle, standby, cold)
   - Click to filter projects by realm

5. **Projects Registry Table**
   - Real projects from database
   - Project name, ID, realm, services, health
   - Manage links to project details
   - Empty state if no projects

### Grafana Dashboard
1. **API Response Times** - Line chart with p50, p95, p99
2. **Page Load Time** - Gauge showing p95
3. **Error Rate** - Gauge showing 5xx percentage
4. **Request Rate** - Line chart by endpoint
5. **Status Distribution** - Pie chart of HTTP status codes
6. **Recent Traces** - Tempo trace viewer

## Verification Commands

```bash
# Check UI is running
docker ps --filter "name=hlidskjalf-ui"

# Check UI logs
docker logs gitlab-sre-hlidskjalf-ui --tail 50

# Check backend API
curl https://hlidskjalf-api.ravenhelm.test/health

# Check platform overview API
curl https://hlidskjalf-api.ravenhelm.test/api/v1/overview

# Check projects API
curl https://hlidskjalf-api.ravenhelm.test/api/v1/projects

# Test telemetry endpoint
curl http://alloy.ravenhelm.test:4318/v1/traces -X POST
```

## Troubleshooting

### Dashboard Shows "Loading..." Forever

**Cause:** API not responding or CORS issues

**Solution:**
```bash
# Check backend is healthy
docker logs gitlab-sre-hlidskjalf --tail 50

# Restart backend
docker-compose restart hlidskjalf

# Check network connectivity
docker exec gitlab-sre-hlidskjalf-ui ping -c 1 hlidskjalf
```

### Stats Cards Show Zero

**Cause:** Database not synced or no projects in database

**Solution:**
```bash
# Check database sync logs
docker logs gitlab-sre-hlidskjalf | grep "Configuration synced"

# Restart to trigger sync
docker-compose restart hlidskjalf

# Manually check database
docker exec gitlab-sre-postgres psql -U postgres -d hlidskjalf -c "SELECT COUNT(*) FROM projects;"
```

### Telemetry Not Showing in Grafana

**Cause:** Alloy not receiving data or Grafana dashboard not loaded

**Solution:**
```bash
# Check Alloy is running
docker ps --filter "name=alloy"

# Check Alloy logs
docker logs gitlab-sre-alloy --tail 50

# Verify dashboard exists
curl -s https://grafana.ravenhelm.test/api/dashboards/uid/hlidskjalf-frontend

# Restart Grafana to reload dashboards
docker-compose restart grafana
```

### "Failed to connect to observability stream"

**Cause:** Observability stream API not ready or NATS/Redpanda not running

**Solution:**
```bash
# Check if endpoint exists
curl https://hlidskjalf-api.ravenhelm.test/api/v1/norns/observability/stream

# Check Redpanda
docker ps --filter "name=redpanda"

# This error is usually transient and resolves automatically
```

## Next Steps

1. **Add Real Data** - Create projects via API or port_registry.yaml
2. **Test Telemetry** - Navigate around the UI and check Grafana
3. **Customize Dashboards** - Adjust Grafana panels to your needs
4. **Add Alerts** - Configure alert notifications in Prometheus
5. **Monitor Performance** - Watch for slow queries or high error rates

## Files Reference

- **Frontend Code:** `/Users/nwalker/Development/hlidskjalf/hlidskjalf/ui/`
- **Backend API:** `/Users/nwalker/Development/hlidskjalf/hlidskjalf/src/api/routes.py`
- **Grafana Dashboard:** `/Users/nwalker/Development/hlidskjalf/observability/grafana/provisioning/dashboards/json/hlidskjalf-frontend.json`
- **Alert Rules:** `/Users/nwalker/Development/hlidskjalf/observability/prometheus/rules/frontend-alerts.yml`
- **Documentation:** `/Users/nwalker/Development/hlidskjalf/docs/runbooks/RUNBOOK-028-dashboard-real-data.md`

---

**Status:** ✅ **ALL SYSTEMS OPERATIONAL**

The dashboard is now fully functional with real-time data, OpenTelemetry instrumentation, and comprehensive observability!

