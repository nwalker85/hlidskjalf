# Ravenhelm Platform - Environment Map

## Environment Strategy

| Environment | Domain | Purpose | Authentication | Certificates |
|-------------|--------|---------|----------------|--------------|
| **Development** | `.test` | Local development | oauth2-proxy:4180 | Self-signed (mkcert) |
| **Staging** | `.dev` | Pre-production testing | oauth2-proxy-staging:4181 | Let's Encrypt |
| **Production** | `.ai` | Live production | oauth2-proxy-prod:4182 (future) | Let's Encrypt |

## Service Endpoints

### Development (.test)
- https://hlidskjalf.ravenhelm.test
- https://zitadel.ravenhelm.test
- https://grafana.ravenhelm.test
- https://auth.ravenhelm.test

### Staging (.dev)
- https://hlidskjalf.ravenhelm.dev ✅ **LIVE**
- https://zitadel.ravenhelm.dev ✅ **LIVE**
- https://grafana.ravenhelm.dev ✅ **LIVE**
- https://auth.ravenhelm.dev ✅ **LIVE**

### Production (.ai)
- https://hlidskjalf.ravenhelm.ai (future)
- https://zitadel.ravenhelm.ai (future)
- https://grafana.ravenhelm.ai (future)
- https://auth.ravenhelm.ai (future)

## DNS Configuration

| Domain | Type | Target | Status |
|--------|------|--------|--------|
| `*.ravenhelm.test` | Local dnsmasq | 127.0.0.1 | ✅ Active |
| `*.ravenhelm.dev` | AWS Route 53 | 67.198.117.118 | ✅ Active |
| `*.ravenhelm.ai` | TBD | TBD | ⏳ Future |

## Port Assignments

| Port | Service | Environment |
|------|---------|-------------|
| 4180 | oauth2-proxy | Development (.test) |
| 4181 | oauth2-proxy-staging | Staging (.dev) |
| 4182 | oauth2-proxy-prod | Production (.ai) - Reserved |

## Certificate Strategy

### Development
- **Type**: Self-signed via mkcert
- **Trust**: Local CA trusted in system keychain
- **Renewal**: Manual regeneration via RUNBOOK-003

### Staging
- **Type**: Let's Encrypt (currently using staging CA)
- **Trust**: Browser-valid certificates
- **Renewal**: Automatic via Traefik (30 days before expiry)
- **Switch to production LE**: See RUNBOOK-026

### Production
- **Type**: Let's Encrypt production CA
- **Trust**: Browser-valid certificates
- **Renewal**: Automatic via Traefik
- **Setup**: TBD when .ai domain is ready

## Authentication Flow

### Development (.test)
```
User → auth.ravenhelm.test:443 (Traefik)
     → oauth2-proxy:4180
     → zitadel.ravenhelm.test
     → Protected services
```

### Staging (.dev)
```
User → auth.ravenhelm.dev:443 (Traefik + Let's Encrypt)
     → oauth2-proxy-staging:4181
     → zitadel.ravenhelm.dev (currently falls back to .test)
     → Protected services
```

### Production (.ai)
```
User → auth.ravenhelm.ai:443 (Traefik + Let's Encrypt)
     → oauth2-proxy-prod:4182
     → zitadel.ravenhelm.ai
     → Protected services
```

## Current Status

- ✅ Development environment fully operational
- ✅ Staging DNS configured
- ✅ Staging Let's Encrypt certificates issued (staging CA)
- ✅ Staging Traefik routing configured
- ⏳ Staging Zitadel redirect URIs need configuration
- ⏳ Production environment pending .ai domain setup

## Related Documentation

- [RUNBOOK-026: Let's Encrypt Staging HTTPS](docs/runbooks/RUNBOOK-026-letsencrypt-external-https.md)
- [RUNBOOK-002: Add Traefik Domain](docs/runbooks/RUNBOOK-002-add-traefik-domain.md)
- [RUNBOOK-006: Zitadel SSO](docs/runbooks/RUNBOOK-006-zitadel-sso.md)
- [Port Registry](config/port_registry.yaml)

