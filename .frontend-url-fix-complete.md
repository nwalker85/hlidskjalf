# Frontend URL Fix - Complete ✅

**Date**: 2025-12-06  
**Issue**: Dashboard at `https://hlidskjalf.ravenhelm.dev` was calling wrong API domain and using HTTP for telemetry

## Root Cause

The hlidskjalf-ui container was running **old JavaScript code** even though the source files had been updated with dynamic URL resolution. Frontend builds create static bundles that don't reflect code changes until the container is rebuilt.

## The Fix

### What Was Already Correct ✅
1. **`hlidskjalf/ui/src/lib/api.ts`** - Had dynamic API URL resolution
2. **`hlidskjalf/ui/src/lib/telemetry.ts`** - Had protocol-aware OTLP endpoint
3. **`hlidskjalf/src/main.py`** - Backend CORS was configured correctly
4. **`ravenhelm-proxy/dynamic.yml`** - CORS middleware and OTLP route were in place

### What Was Missing ❌
**The container wasn't rebuilt after code changes!**

### Solution Applied
```bash
cd /Users/nwalker/Development/hlidskjalf
docker-compose up -d --build hlidskjalf-ui
```

## How It Works Now

### 1. API Calls
```typescript
// Frontend automatically determines correct API domain
const API_BASE = window.location.origin.replace('hlidskjalf.', 'hlidskjalf-api.')

// Result:
// https://hlidskjalf.ravenhelm.test → https://hlidskjalf-api.ravenhelm.test
// https://hlidskjalf.ravenhelm.dev  → https://hlidskjalf-api.ravenhelm.dev
// https://hlidskjalf.ravenhelm.ai   → https://hlidskjalf-api.ravenhelm.ai
```

### 2. Telemetry (OpenTelemetry Traces)
```typescript
// Frontend matches page protocol and routes through Traefik
function getOTLPEndpoint(): string {
  const hostname = window.location.hostname;
  const protocol = window.location.protocol;  // 'http:' or 'https:'
  const domain = hostname.split('.').slice(-2).join('.');
  
  return `${protocol}//otel.${domain}`;
}

// Result:
// https://hlidskjalf.ravenhelm.test → https://otel.ravenhelm.test
// https://hlidskjalf.ravenhelm.dev  → https://otel.ravenhelm.dev
```

## Testing

### Before Testing
1. **Clear browser cache** or open in incognito/private window
2. Open browser DevTools Console
3. Navigate to `https://hlidskjalf.ravenhelm.dev`

### Expected Behavior ✅
**Console should show:**
```
[Telemetry] OpenTelemetry initialized successfully
[Telemetry] Exporting to: https://otel.ravenhelm.dev
```

**Network tab should show:**
- ✅ `GET https://hlidskjalf-api.ravenhelm.dev/api/v1/overview` - Status 200
- ✅ `GET https://hlidskjalf-api.ravenhelm.dev/api/v1/projects` - Status 200
- ✅ No CORS errors
- ✅ No Mixed Content warnings

### Previous Behavior (Before Fix) ❌
**Console showed:**
```
[Telemetry] Exporting to: http://alloy.ravenhelm.test:4318  ← Wrong! HTTP + wrong domain
```

**Network tab showed:**
- ❌ `GET https://hlidskjalf-api.ravenhelm.test/api/v1/overview` - CORS Error
- ❌ Mixed Content: Blocked loading from `http://...` on HTTPS page

## Key Lessons

### 1. Frontend Builds Are Static
- JavaScript bundles are created at **build time**
- Code changes don't take effect until container is **rebuilt**
- `docker-compose restart` won't pick up code changes
- Must use `docker-compose up -d --build <service>`

### 2. Dynamic Configuration
- Single codebase works across all environments
- No environment variables needed for domain resolution
- Leverage `window.location` for automatic environment detection

### 3. Mixed Content Policy
- HTTPS pages **cannot** make HTTP requests
- Browsers enforce this strictly
- Solution: Route everything through Traefik with matching protocol

### 4. CORS Middleware Order
- CORS headers must be applied **before** authentication
- OPTIONS preflight needs CORS headers to succeed
- Traefik chain order: `cors → secure-headers → auth`

## Related Files

### Modified
- `docs/LESSONS_LEARNED.md` - Added container rebuild insights

### Verified (Correct, No Changes)
- `hlidskjalf/ui/src/lib/api.ts` - Dynamic API URL
- `hlidskjalf/ui/src/lib/telemetry.ts` - Dynamic OTLP endpoint
- `hlidskjalf/src/main.py` - CORS configuration
- `ravenhelm-proxy/dynamic.yml` - CORS middleware, OTLP route

## Status

**Container Status:**
```bash
$ docker ps --filter "name=hlidskjalf-ui"
NAMES                      STATUS         PORTS
gitlab-sre-hlidskjalf-ui   Up 3 minutes   0.0.0.0:3900->3900/tcp
```

**Ready to test at:**
- https://hlidskjalf.ravenhelm.dev (staging)
- https://hlidskjalf.ravenhelm.test (dev - should still work)

---

## Quick Reference

### Rebuild Frontend
```bash
cd /Users/nwalker/Development/hlidskjalf
docker-compose up -d --build hlidskjalf-ui
```

### Check Logs
```bash
docker logs -f gitlab-sre-hlidskjalf-ui
```

### Verify CORS
```bash
curl -s -H "Origin: https://hlidskjalf.ravenhelm.dev" \
  -X OPTIONS https://hlidskjalf-api.ravenhelm.dev/api/v1/overview -I \
  | grep -i "access-control"
```

### Verify OTLP Endpoint
```bash
curl -s -o /dev/null -w "%{http_code}" https://otel.ravenhelm.dev/v1/traces
# Expected: 405 (Method Not Allowed - means endpoint is accessible)
```

