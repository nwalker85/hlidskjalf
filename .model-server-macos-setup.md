# External Model Server Setup - macOS M5 (Apple Silicon)

**Target Machine**: models.ravenhelm (192.168.50.26)  
**Platform**: macOS with M5 (Apple Silicon ARM64)  
**Port**: 6701

---

## üçé macOS-Specific Quick Setup

### 1. Download SPIRE (ARM64)

```bash
cd ~/Downloads

# SPIRE Agent (ARM64 for Apple Silicon)
curl -L https://github.com/spiffe/spire/releases/download/v1.9.0/spire-1.9.0-darwin-arm64.tar.gz -o spire.tar.gz
tar -xzf spire.tar.gz
sudo mv spire-1.9.0/bin/* /usr/local/bin/
sudo mkdir -p /opt/spire/{conf,data}

# Verify installation
spire-agent --version
```

### 2. Download spiffe-helper (ARM64)

```bash
# spiffe-helper (ARM64)
curl -L https://github.com/spiffe/spiffe-helper/releases/download/v0.6.0/spiffe-helper_0.6.0_darwin_arm64.tar.gz -o helper.tar.gz
tar -xzf helper.tar.gz
sudo mv spiffe-helper /usr/local/bin/

# Verify installation
spiffe-helper --version
```

### 3. Create SPIRE Agent Config

```bash
# Update this IP to match your SPIRE server IP
SPIRE_SERVER_IP="10.10.0.10"  # Replace with actual IP if different

sudo tee /opt/spire/conf/agent.conf << EOF
agent {
    data_dir = "/opt/spire/data"
    log_level = "INFO"
    server_address = "$SPIRE_SERVER_IP"
    server_port = "8081"
    socket_path = "/tmp/spire-agent/public/api.sock"
    trust_domain = "ravenhelm.local"
}

plugins {
    NodeAttestor "join_token" {
        plugin_data {}
    }
    
    KeyManager "disk" {
        plugin_data {
            directory = "/opt/spire/data"
        }
    }
    
    WorkloadAttestor "unix" {
        plugin_data {}
    }
}
EOF

# Create socket directory
sudo mkdir -p /tmp/spire-agent/public
```

### 4. Get Join Token from Hli√∞skj√°lf

On your Hli√∞skj√°lf platform, run:

```bash
./scripts/register-model-server-spire.sh --generate-token
```

Copy the join token that's displayed.

### 5. Start SPIRE Agent

```bash
# Start once with join token
sudo /usr/local/bin/spire-agent run \
    -config /opt/spire/conf/agent.conf \
    -joinToken "YOUR_TOKEN_HERE" &

# Wait a few seconds for it to connect
sleep 5

# Check health
/usr/local/bin/spire-agent healthcheck \
    -socketPath /tmp/spire-agent/public/api.sock
```

### 6. Create launchd Service (Auto-start)

```bash
sudo tee /Library/LaunchDaemons/com.spiffe.agent.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.spiffe.agent</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/spire-agent</string>
        <string>run</string>
        <string>-config</string>
        <string>/opt/spire/conf/agent.conf</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/var/log/spire-agent.log</string>
    <key>StandardErrorPath</key>
    <string>/var/log/spire-agent-error.log</string>
</dict>
</plist>
EOF

sudo launchctl load /Library/LaunchDaemons/com.spiffe.agent.plist
```

### 7. Setup spiffe-helper

```bash
sudo tee /etc/spiffe-helper.conf << 'EOF'
agent_address = "/tmp/spire-agent/public/api.sock"
cert_dir = "/tmp/spire-certs"
svid_file_name = "svid.pem"
svid_key_file_name = "key.pem"
svid_bundle_file_name = "bundle.pem"
add_intermediates_to_bundle = true
EOF

# Create cert directory
sudo mkdir -p /tmp/spire-certs

# Start spiffe-helper
sudo /usr/local/bin/spiffe-helper -config /etc/spiffe-helper.conf &

# Or create launchd service for spiffe-helper
sudo tee /Library/LaunchDaemons/com.spiffe.helper.plist << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.spiffe.helper</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/spiffe-helper</string>
        <string>-config</string>
        <string>/etc/spiffe-helper.conf</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/var/log/spiffe-helper.log</string>
    <key>StandardErrorPath</key>
    <string>/var/log/spiffe-helper-error.log</string>
</dict>
</plist>
EOF

sudo launchctl load /Library/LaunchDaemons/com.spiffe.helper.plist
```

### 8. Configure Ollama (if that's your model server)

```bash
# Stop Ollama if running
pkill ollama

# Set environment variables
export OLLAMA_HOST=https://0.0.0.0:6701
export OLLAMA_CERT_FILE=/tmp/spire-certs/svid.pem
export OLLAMA_KEY_FILE=/tmp/spire-certs/key.pem

# Start Ollama
ollama serve

# Or create launchd service
sudo tee /Library/LaunchDaemons/com.ollama.server.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.ollama.server</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/ollama</string>
        <string>serve</string>
    </array>
    <key>EnvironmentVariables</key>
    <dict>
        <key>OLLAMA_HOST</key>
        <string>https://0.0.0.0:6701</string>
        <key>OLLAMA_CERT_FILE</key>
        <string>/tmp/spire-certs/svid.pem</string>
        <key>OLLAMA_KEY_FILE</key>
        <string>/tmp/spire-certs/key.pem</string>
    </dict>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>/var/log/ollama.log</string>
    <key>StandardErrorPath</key>
    <string>/var/log/ollama-error.log</string>
</dict>
</plist>
EOF

sudo launchctl load /Library/LaunchDaemons/com.ollama.server.plist
```

---

## üîç Verification

### Check SPIRE Agent

```bash
# Health check
/usr/local/bin/spire-agent healthcheck \
    -socketPath /tmp/spire-agent/public/api.sock

# Fetch SVID (should show certificate)
/usr/local/bin/spire-agent api fetch x509 \
    -socketPath /tmp/spire-agent/public/api.sock

# Check logs
tail -f /var/log/spire-agent.log
```

### Check Certificates

```bash
# List certificates
ls -la /tmp/spire-certs/

# Check certificate details
openssl x509 -in /tmp/spire-certs/svid.pem -text -noout

# Check expiry
openssl x509 -in /tmp/spire-certs/svid.pem -noout -dates
```

### Test Ollama

```bash
# Local test
curl -k https://localhost:6701/api/tags

# From network
curl https://192.168.50.26:6701/api/tags
```

---

## üõ†Ô∏è Troubleshooting

### SPIRE Agent Won't Start

```bash
# Check if port 8081 is reachable
nc -zv 10.10.0.10 8081

# Check agent logs
cat /var/log/spire-agent.log
cat /var/log/spire-agent-error.log

# Check if socket exists
ls -la /tmp/spire-agent/public/
```

### Certificates Not Generated

```bash
# Check spiffe-helper logs
cat /var/log/spiffe-helper.log

# Manually test SVID fetch
/usr/local/bin/spire-agent api fetch x509 \
    -socketPath /tmp/spire-agent/public/api.sock \
    -write /tmp/test-certs/
```

### Ollama Won't Start with HTTPS

```bash
# Check if certificates exist
ls -la /tmp/spire-certs/

# Check certificate permissions
sudo chmod 644 /tmp/spire-certs/*.pem

# Start Ollama in foreground to see errors
OLLAMA_HOST=https://0.0.0.0:6701 \
OLLAMA_CERT_FILE=/tmp/spire-certs/svid.pem \
OLLAMA_KEY_FILE=/tmp/spire-certs/key.pem \
ollama serve
```

---

## üîß macOS Service Management

### Start/Stop Services

```bash
# SPIRE Agent
sudo launchctl start com.spiffe.agent
sudo launchctl stop com.spiffe.agent

# spiffe-helper
sudo launchctl start com.spiffe.helper
sudo launchctl stop com.spiffe.helper

# Ollama
sudo launchctl start com.ollama.server
sudo launchctl stop com.ollama.server
```

### View Service Status

```bash
# List loaded services
sudo launchctl list | grep spiffe
sudo launchctl list | grep ollama

# View logs
tail -f /var/log/spire-agent.log
tail -f /var/log/spiffe-helper.log
tail -f /var/log/ollama.log
```

### Unload Services

```bash
sudo launchctl unload /Library/LaunchDaemons/com.spiffe.agent.plist
sudo launchctl unload /Library/LaunchDaemons/com.spiffe.helper.plist
sudo launchctl unload /Library/LaunchDaemons/com.ollama.server.plist
```

---

## üìù Notes

- **Socket Path**: macOS uses `/tmp/spire-agent/public/api.sock` instead of `/run/spire/sockets/api.sock`
- **Cert Path**: Using `/tmp/spire-certs` instead of `/run/spire/certs` for compatibility
- **launchd vs systemd**: macOS uses launchd services (.plist files) instead of systemd
- **Permissions**: macOS may require `sudo` for accessing certain directories
- **Firewall**: Check macOS firewall settings if connections fail (`System Preferences ‚Üí Security & Privacy ‚Üí Firewall`)

---

## üîó Related Documentation

- **Full Setup Guide**: `docs/runbooks/RUNBOOK-031-external-model-server-mtls.md`
- **Quick Start**: `.model-server-quick-start.md`
- **Platform Instructions**: From Hli√∞skj√°lf, run `./scripts/register-model-server-spire.sh --generate-token`


