# External Model Server mTLS Migration

**Date**: 2025-12-06  
**Status**: Configuration Complete - Ready for Deployment  
**Service**: models.ravenhelm (192.168.50.26:6701)

---

## Summary

Migrated the external model server from **Basic Auth** to **SPIRE-based mTLS** for zero-trust authentication, aligning with all other backend services in the Hliðskjálf platform.

---

## Changes Made

### 1. Port Registry Update

**File**: `config/port_registry.yaml`

Added entry for the external model server:

```yaml
- port: 6701
  service: model-server
  protocol: tcp
  description: External model server (Ollama/LLM endpoint)
  host: 192.168.50.26
  domain: models.ravenhelm.dev
  security: mTLS (SPIRE)
  note: External machine - requires SPIRE agent on host or Traefik client cert
```

### 2. Traefik Configuration

**File**: `ravenhelm-proxy/dynamic.yml`

#### Added mTLS Transport

```yaml
serversTransports:
  model-server-transport:
    rootCAs:
      - /certs/spire-bundle.pem
    certificates:
      - certFile: /run/spire/certs/svid.pem
        keyFile: /run/spire/certs/key.pem
    insecureSkipVerify: false
```

#### Updated Router

**Before**: Basic Auth middleware  
**After**: mTLS via SPIRE client certificate

```yaml
routers:
  model-server:
    rule: "Host(`models.ravenhelm.dev`)"
    service: model-server-svc
    middlewares:
      - secure-headers
    tls:
      certResolver: letsencrypt
```

#### Updated Service

**Before**: `http://192.168.50.26:6701`  
**After**: `https://192.168.50.26:6701` with mTLS transport

```yaml
services:
  model-server-svc:
    loadBalancer:
      serversTransport: model-server-transport
      servers:
        - url: "https://192.168.50.26:6701"
```

### 3. SPIFFE Helper Configuration

**File**: `config/spiffe-helper/model-server-helper.conf`

Created configuration for use on the external machine (192.168.50.26) to fetch SVIDs from the local SPIRE agent.

### 4. Registration Script

**File**: `scripts/register-model-server-spire.sh`

Automated script to:
- Generate join tokens for external SPIRE agent
- Register the model server workload with SPIRE
- Verify registration
- Display next steps

Usage:
```bash
./scripts/register-model-server-spire.sh --generate-token
```

### 5. Documentation

**File**: `docs/runbooks/RUNBOOK-031-external-model-server-mtls.md`

Comprehensive runbook covering:
- **Option A**: Full SPIRE mTLS (both sides use SPIRE)
- **Option B**: Traefik client cert (simpler, one-way)
- Step-by-step setup instructions
- Troubleshooting guide
- Security considerations

### 6. Runbook Catalog

**File**: `docs/wiki/Runbook_Catalog.md`

Added entry for the new runbook.

---

## Deployment Steps

### Prerequisites

- [ ] SPIRE server running (`docker ps | grep spire-server`)
- [ ] Traefik has SPIRE certificates mounted
- [ ] Network connectivity between Traefik and 192.168.50.26:6701
- [ ] SSH/console access to 192.168.50.26

### On Hliðskjálf Platform

```bash
# 1. Register the model server and generate join token
./scripts/register-model-server-spire.sh --generate-token

# Save the join token - it expires in 10 minutes
```

### On External Machine (192.168.50.26 - macOS M5)

> **Automated Setup**: Use `scripts/setup-model-server-macos.sh` for automated installation
> **Manual Instructions**: See `.model-server-macos-setup.md` for step-by-step guide

**Automated (Recommended):**

```bash
# Transfer script to external machine (choose one method):

# Method 1: AirDrop (easiest)
open -R scripts/setup-model-server-macos.sh
# Then AirDrop to the external Mac

# Method 2: Temporary HTTP server
cd scripts
python3 -m http.server 8888
# On external machine: curl http://YOUR_IP:8888/setup-model-server-macos.sh -o setup.sh

# Method 3: Copy to shared network folder
cp scripts/setup-model-server-macos.sh /Volumes/SharedFolder/

# Then on external machine (192.168.50.26):
chmod +x setup-model-server-macos.sh
./setup-model-server-macos.sh
```

**Manual:**

```bash
# 2. Install SPIRE agent (macOS ARM64 - M5)
curl -L https://github.com/spiffe/spire/releases/download/v1.9.0/spire-1.9.0-darwin-arm64.tar.gz -o spire.tar.gz
tar -xzf spire.tar.gz
sudo mv spire-1.9.0/bin/* /usr/local/bin/

# 3. Create agent configuration
sudo mkdir -p /opt/spire/{conf,data}
sudo tee /opt/spire/conf/agent.conf << 'EOF'
agent {
    data_dir = "/opt/spire/data"
    log_level = "INFO"
    server_address = "10.10.0.10"  # Update with actual SPIRE server IP
    server_port = "8081"
    socket_path = "/run/spire/sockets/api.sock"
    trust_domain = "ravenhelm.local"
}

plugins {
    NodeAttestor "join_token" {
        plugin_data {}
    }
    
    KeyManager "disk" {
        plugin_data {
            directory = "/opt/spire/data"
        }
    }
    
    WorkloadAttestor "unix" {
        plugin_data {}
    }
}
EOF

# 4. Start agent with join token (from step 1)
sudo /usr/local/bin/spire-agent run \
    -config /opt/spire/conf/agent.conf \
    -joinToken "YOUR_TOKEN_HERE" &

# 5. Install spiffe-helper (macOS ARM64)
curl -L https://github.com/spiffe/spiffe-helper/releases/download/v0.6.0/spiffe-helper_0.6.0_darwin_arm64.tar.gz -o helper.tar.gz
tar -xzf helper.tar.gz
sudo mv spiffe-helper /usr/local/bin/

# 6. Copy spiffe-helper config from platform
# (Transfer config/spiffe-helper/model-server-helper.conf to /etc/spiffe-helper.conf)

# 7. Start spiffe-helper
sudo mkdir -p /run/spire/certs
sudo /usr/local/bin/spiffe-helper -config /etc/spiffe-helper.conf &

# 8. Configure model service to use SPIRE certificates
# For Ollama:
export OLLAMA_HOST=https://0.0.0.0:6701
export OLLAMA_CERT_FILE=/run/spire/certs/svid.pem
export OLLAMA_KEY_FILE=/run/spire/certs/key.pem

# For other services, update TLS config to point to:
# - Cert: /run/spire/certs/svid.pem
# - Key:  /run/spire/certs/key.pem
# - CA:   /run/spire/certs/bundle.pem
```

### Back on Hliðskjálf Platform

```bash
# 9. Restart Traefik to pick up new configuration
docker restart ravenhelm-proxy

# 10. Test connection
curl https://models.ravenhelm.dev/health
curl https://models.ravenhelm.dev/v1/models
```

---

## Verification

### Check SPIRE Registration

```bash
# List all entries
docker exec gitlab-sre-spire-server /opt/spire/bin/spire-server entry show

# Check model server specifically
docker exec gitlab-sre-spire-server /opt/spire/bin/spire-server entry show \
    -spiffeID spiffe://ravenhelm.local/workload/model-server
```

### Test mTLS Connection

```bash
# From Traefik container
docker exec ravenhelm-proxy curl -v https://192.168.50.26:6701/health

# Check certificate details
openssl s_client -connect 192.168.50.26:6701 \
    -cert /run/spire/certs/svid.pem \
    -key /run/spire/certs/key.pem \
    -CAfile /run/spire/certs/bundle.pem
```

### Monitor Logs

```bash
# Traefik logs
docker logs ravenhelm-proxy -f | grep model-server

# SPIRE agent logs (on external machine)
journalctl -u spire-agent -f
```

---

## Rollback Plan

If issues occur, revert to Basic Auth:

```bash
# 1. Update dynamic.yml router to use model-server-protected middleware
# 2. Change service URL back to http://192.168.50.26:6701
# 3. Remove serversTransport: model-server-transport
# 4. Restart Traefik: docker restart ravenhelm-proxy
```

---

## Security Benefits

1. ✅ **Zero-Trust**: No static credentials (Basic Auth removed)
2. ✅ **Auto-Rotation**: SPIRE rotates certificates every hour
3. ✅ **Mutual Authentication**: Both client and server verify identity
4. ✅ **Consistent Security**: Same mTLS pattern as Postgres, Redis, NATS, GitLab MCP
5. ✅ **Audit Trail**: SPIRE logs all identity issuance

---

## Architecture

```
┌─────────────────┐
│   Client        │
│  (Browser/API)  │
└────────┬────────┘
         │ HTTPS
         ▼
┌─────────────────────────────────────────┐
│  Traefik (ravenhelm-proxy)              │
│  - Terminates client HTTPS              │
│  - Presents SVID as client cert         │
│  - Validates server SVID                │
└────────┬────────────────────────────────┘
         │ mTLS (SPIRE)
         ▼
┌─────────────────────────────────────────┐
│  Model Server (192.168.50.26:6701)      │
│  - Presents SVID as server cert         │
│  - Validates Traefik SVID               │
│  - Proxies to Ollama/LLM backend        │
└─────────────────────────────────────────┘
```

---

## Related Documentation

- [RUNBOOK-031: External Model Server mTLS Setup](docs/runbooks/RUNBOOK-031-external-model-server-mtls.md)
- [RUNBOOK-004: SPIRE Management](docs/runbooks/RUNBOOK-004-spire-management.md)
- [RUNBOOK-024: Add Shared Service](docs/runbooks/RUNBOOK-024-add-shared-service.md)

---

## Notes

- The external machine (192.168.50.26) must have network connectivity to the SPIRE server (10.10.0.10:8081)
- Join tokens expire after 10 minutes - generate a new one if needed
- SVIDs auto-rotate every hour (default TTL: 3600s, rotation at ~50%)
- For production, consider setting up systemd services for spire-agent and spiffe-helper
- The workload selector uses `unix:uid:1001` - adjust if the model service runs as a different user


