# External Model Server - Quick Start Guide

**Service**: models.ravenhelm (192.168.50.26:6701)  
**Security**: SPIRE mTLS (zero-trust)

---

## ðŸš€ Quick Deploy (5 Steps)

### 1. Generate Join Token

```bash
cd /Users/nwalker/Development/hlidskjalf
./scripts/register-model-server-spire.sh --generate-token
```

**Output**: Join token (expires in 10 min) + instructions

---

### 2. On External Machine (192.168.50.26)

**Option A: Automated Setup (Recommended for macOS)**

Transfer the script to 192.168.50.26 using one of these methods:
- **AirDrop**: Open Finder, drag `scripts/setup-model-server-macos.sh` to AirDrop
- **HTTP**: Run `python3 -m http.server 8888` in the scripts folder, then download from external machine
- **Shared folder**: Copy to network share
- **Copy/paste**: Open script, copy contents, create on external machine

Then on 192.168.50.26:
```bash
chmod +x setup-model-server-macos.sh
./setup-model-server-macos.sh
# The script will prompt for the join token
```

**Option B: Manual Setup**

```bash
# Install SPIRE agent (macOS ARM64 - M1/M2/M3/M4/M5)
curl -L https://github.com/spiffe/spire/releases/download/v1.9.0/spire-1.9.0-darwin-arm64.tar.gz -o spire.tar.gz
tar -xzf spire.tar.gz
sudo mv spire-1.9.0/bin/* /usr/local/bin/

# Create config (update SPIRE server IP if needed)
sudo mkdir -p /opt/spire/conf
sudo tee /opt/spire/conf/agent.conf << 'EOF'
agent {
    data_dir = "/opt/spire/data"
    log_level = "INFO"
    server_address = "10.10.0.10"
    server_port = "8081"
    socket_path = "/run/spire/sockets/api.sock"
    trust_domain = "ravenhelm.local"
}

plugins {
    NodeAttestor "join_token" { plugin_data {} }
    KeyManager "disk" { plugin_data { directory = "/opt/spire/data" } }
    WorkloadAttestor "unix" { plugin_data {} }
}
EOF

# Start agent (use token from step 1)
sudo /usr/local/bin/spire-agent run \
    -config /opt/spire/conf/agent.conf \
    -joinToken "PASTE_TOKEN_HERE" &
```

---

### 3. Setup spiffe-helper

```bash
# Install (macOS ARM64)
curl -L https://github.com/spiffe/spiffe-helper/releases/download/v0.6.0/spiffe-helper_0.6.0_darwin_arm64.tar.gz -o helper.tar.gz
tar -xzf helper.tar.gz
sudo mv spiffe-helper /usr/local/bin/

# Configure
sudo tee /etc/spiffe-helper.conf << 'EOF'
agent_address = "/run/spire/sockets/api.sock"
cert_dir = "/run/spire/certs"
svid_file_name = "svid.pem"
svid_key_file_name = "key.pem"
svid_bundle_file_name = "bundle.pem"
add_intermediates_to_bundle = true
EOF

# Start
sudo mkdir -p /run/spire/certs
sudo /usr/local/bin/spiffe-helper -config /etc/spiffe-helper.conf &
```

---

### 4. Configure Model Service

**For Ollama:**
```bash
export OLLAMA_HOST=https://0.0.0.0:6701
export OLLAMA_CERT_FILE=/run/spire/certs/svid.pem
export OLLAMA_KEY_FILE=/run/spire/certs/key.pem
ollama serve
```

**For Nginx Proxy:**
```nginx
server {
    listen 6701 ssl;
    ssl_certificate /run/spire/certs/svid.pem;
    ssl_certificate_key /run/spire/certs/key.pem;
    ssl_client_certificate /run/spire/certs/bundle.pem;
    ssl_verify_client on;
    
    location / {
        proxy_pass http://127.0.0.1:11434;
    }
}
```

---

### 5. Test from Platform

```bash
# Restart Traefik
docker restart ravenhelm-proxy

# Test connection
curl https://models.ravenhelm.dev/v1/models
curl https://models.ravenhelm.dev/health
```

---

## âœ… Verification

```bash
# Check SPIRE registration
docker exec gitlab-sre-spire-server \
    /opt/spire/bin/spire-server entry show \
    -spiffeID spiffe://ravenhelm.local/workload/model-server

# Check mTLS handshake
openssl s_client -connect 192.168.50.26:6701 \
    -cert /run/spire/certs/svid.pem \
    -key /run/spire/certs/key.pem \
    -CAfile /run/spire/certs/bundle.pem

# Monitor certificate rotation
watch -n 5 'openssl x509 -in /run/spire/certs/svid.pem -noout -dates'
```

---

## ðŸ”§ Troubleshooting

| Issue | Check | Fix |
|-------|-------|-----|
| Agent won't connect | `telnet 10.10.0.10 8081` | Verify network/firewall |
| No SVID issued | `/usr/local/bin/spire-agent healthcheck` | Check agent logs |
| Traefik can't connect | `docker logs ravenhelm-proxy` | Verify serversTransport |
| Certificate errors | `openssl x509 -in /run/spire/certs/svid.pem -text` | Check SVID validity |

---

## ðŸ“š Full Documentation

- **Detailed Setup**: `docs/runbooks/RUNBOOK-031-external-model-server-mtls.md`
- **SPIRE Management**: `docs/runbooks/RUNBOOK-004-spire-management.md`
- **Migration Notes**: `.model-server-mtls-migration.md`

---

## ðŸ” Security Notes

- âœ… No static credentials (Basic Auth removed)
- âœ… Certificates auto-rotate every hour
- âœ… Mutual authentication (both sides verify)
- âœ… Consistent with all platform services
- âœ… Full audit trail via SPIRE


