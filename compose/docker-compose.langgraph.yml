# Ravenhelm Platform - LangGraph & Hlidskjalf Stack
# ====================================================
# Norns AI agent + Platform dashboard (isolated for independent restart)
#
# Services: langgraph (Norns), hlidskjalf (API), hlidskjalf-ui
# Dependencies: postgres, redis, nats, ollama, zitadel (via platform_net)
#
# Start: docker compose -f compose/docker-compose.langgraph.yml up -d

include:
  - docker-compose.base.yml

services:
  # =========================================================================
  # LANGGRAPH - Norns AI Agent (The Three Sisters)
  # =========================================================================
  langgraph:
    image: hlidskjalf-langgraph:latest
    build:
      context: ../hlidskjalf
      dockerfile: Dockerfile.langgraph
    container_name: gitlab-sre-langgraph
    labels:
      - "ravenhelm.project=hlidskjalf"
      - "ravenhelm.service=langgraph"
      - "ravenhelm.workload=ai-agent"
    ports:
      - "2024:2024"
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access LM Studio on host
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
      - LANGSMITH_TRACING=${LANGSMITH_TRACING:-false}
      - REDIS_URL=rediss://:ravenhelm-redis-dev-password@redis:6379?ssl_cert_reqs=none
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/hlidskjalf
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=ravenhelm
      - NATS_URL=nats://nats:4222
      - KAFKA_BOOTSTRAP=redpanda:9092
      # LLM Provider: 'ollama', 'lmstudio', 'openai'
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
      - LMSTUDIO_URL=${LMSTUDIO_URL:-http://host.docker.internal:1234/v1}
      - LMSTUDIO_MODEL=${LMSTUDIO_MODEL:-ministral-3-14b-reasoning}
      - LMSTUDIO_API_KEY=${LMSTUDIO_API_KEY:-lm-studio}
    volumes:
      # Mount the ENTIRE project root for workspace access
      - ..:/app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2024/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - platform_net

  # =========================================================================
  # HLIÐSKJÁLF - Platform API (Control Plane)
  # =========================================================================
  hlidskjalf:
    image: hlidskjalf-hlidskjalf:latest
    build:
      context: ../hlidskjalf
      dockerfile: Dockerfile
    container_name: gitlab-sre-hlidskjalf
    labels:
      - "ravenhelm.project=hlidskjalf"
      - "ravenhelm.service=api"
      - "ravenhelm.workload=control-plane"
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/hlidskjalf
      - REDIS_URL=rediss://:ravenhelm-redis-dev-password@redis:6379/2?ssl_cert_reqs=none
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://alloy:4317
      - SPIRE_AGENT_SOCKET=/tmp/spire-agent/public/api.sock
      - TRUST_DOMAIN=ravenhelm.local
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      # The Norns - AI Agent
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - NORNS_MODEL=gpt-4o
      - LANGFUSE_HOST=http://langfuse-server:3000
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
    volumes:
      - ../hlidskjalf/src:/app/src:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "8900:8900"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8900/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - platform_net

  # =========================================================================
  # HLIÐSKJÁLF UI - Platform Dashboard
  # =========================================================================
  hlidskjalf-ui:
    image: hlidskjalf-hlidskjalf-ui:latest
    build:
      context: ../hlidskjalf/ui
      dockerfile: Dockerfile
      args:
        - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
    container_name: gitlab-sre-hlidskjalf-ui
    labels:
      - "ravenhelm.project=hlidskjalf"
      - "ravenhelm.service=ui"
      - "ravenhelm.workload=control-plane"
    environment:
      - NEXT_PUBLIC_API_URL=https://hlidskjalf-api.ravenhelm.test
      - NEXT_PUBLIC_LANGGRAPH_API_URL=https://norns.ravenhelm.test
      - NEXT_PUBLIC_LANGGRAPH_ASSISTANT_ID=norns
      - BACKEND_URL=http://hlidskjalf:8900
      # Internal Docker URL for server-side API calls
      - LANGGRAPH_API_URL=http://langgraph:2024
      # NextAuth Zitadel SSO (Server-side OIDC)
      - AUTH_ZITADEL_ISSUER=https://zitadel.ravenhelm.test
      - AUTH_ZITADEL_CLIENT_ID=${NEXTAUTH_HLIDSKJALF_CLIENT_ID}
      - AUTH_ZITADEL_CLIENT_SECRET=${NEXTAUTH_HLIDSKJALF_CLIENT_SECRET}
      - NEXTAUTH_URL=https://hlidskjalf.ravenhelm.test
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - AUTH_TRUST_HOST=true
      # Trust self-signed certs in dev (required for Zitadel SSO)
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    extra_hosts:
      - "zitadel.ravenhelm.test:host-gateway"
      - "hlidskjalf-api.ravenhelm.test:host-gateway"
    ports:
      - "3900:3900"
    depends_on:
      - hlidskjalf
      - langgraph
    restart: unless-stopped
    networks:
      - platform_net

