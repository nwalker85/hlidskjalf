services:
  nginx:
    image: nginx:alpine
    container_name: gitlab-sre-nginx
    ports:
      - "11443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/certs:/etc/nginx/certs:ro
    depends_on:
      gitlab:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - gitlab-network

  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: gitlab-sre-gitlab
    hostname: gitlab.ravenhelm.test
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        # External URL (accessed via ravenhelm-proxy)
        external_url 'https://gitlab.ravenhelm.test'
        nginx['listen_port'] = 80
        nginx['listen_https'] = false

        # Registry
        registry_external_url 'https://registry.gitlab.ravenhelm.test'
        gitlab_rails['registry_enabled'] = true
        registry['enable'] = true
        registry_nginx['listen_port'] = 5050
        registry_nginx['listen_https'] = false

        # Performance tuning for local dev
        puma['worker_processes'] = 2
        sidekiq['concurrency'] = 10
        postgresql['shared_buffers'] = "256MB"
        prometheus_monitoring['enable'] = false

        # Disable unnecessary services for local dev
        alertmanager['enable'] = false

        # SSH (optional - direct port)
        gitlab_rails['gitlab_shell_ssh_port'] = 2222

        # Time zone
        gitlab_rails['time_zone'] = 'America/New_York'
    ports:
      - "2222:22"  # SSH for git operations
    volumes:
      - gitlab_config:/etc/gitlab
      - gitlab_logs:/var/log/gitlab
      - gitlab_data:/var/opt/gitlab
    shm_size: '256m'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s  # GitLab takes a while to start
    restart: unless-stopped
    networks:
      - gitlab-network

  gitlab-runner:
    image: gitlab/gitlab-runner:latest
    container_name: gitlab-sre-runner
    volumes:
      - gitlab_runner_config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      gitlab:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # LOCALSTACK - AWS Services Emulation
  # =========================================================================
  localstack:
    image: localstack/localstack:latest
    container_name: gitlab-sre-localstack
    ports:
      - "4566:4566"           # LocalStack Gateway
    environment:
      - SERVICES=secretsmanager,ssm,s3,sqs,sns,kms,iam,sts
      - DEBUG=0
      - PERSISTENCE=1
      - LOCALSTACK_HOST=localhost.localstack.cloud
    volumes:
      - localstack_data:/var/lib/localstack
      - /var/run/docker.sock:/var/run/docker.sock
      - ./localstack/init:/etc/localstack/init/ready.d
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - gitlab-network


  # =========================================================================
  # OBSERVABILITY - OpenTelemetry Collector
  # =========================================================================
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: gitlab-sre-otel
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./observability/otel-collector/config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8889:8889"   # Prometheus exporter metrics
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # OBSERVABILITY - Prometheus (Metrics)
  # =========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: gitlab-sre-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
      - '--web.enable-remote-write-receiver'
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # OBSERVABILITY - Loki (Logs)
  # =========================================================================
  loki:
    image: grafana/loki:latest
    container_name: gitlab-sre-loki
    command: -config.file=/etc/loki/loki-config.yaml
    volumes:
      - ./observability/loki/loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - loki_data:/loki
    ports:
      - "3100:3100"
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # OBSERVABILITY - Tempo (Traces)
  # =========================================================================
  tempo:
    image: grafana/tempo:latest
    container_name: gitlab-sre-tempo
    user: "0"  # Run as root to avoid permission issues
    command: ["-config.file=/etc/tempo/tempo-config.yaml"]
    volumes:
      - ./observability/tempo/tempo-config.yaml:/etc/tempo/tempo-config.yaml:ro
      - tempo_data:/var/tempo
    ports:
      - "3200:3200"   # Tempo API
      - "9095:9095"   # Tempo gRPC
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # OBSERVABILITY - Grafana (Dashboards)
  # =========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: gitlab-sre-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=ravenhelm
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=https://grafana.observe.ravenhelm.test
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor tempoSearch tempoBackendSearch
    volumes:
      - ./observability/grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana_data:/var/lib/grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - loki
      - tempo
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # OBSERVABILITY - Alertmanager
  # =========================================================================
  alertmanager:
    image: prom/alertmanager:latest
    container_name: gitlab-sre-alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    volumes:
      - ./observability/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    ports:
      - "9093:9093"
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # OBSERVABILITY - nginx for observe.ravenhelm.test
  # =========================================================================
  observe-nginx:
    image: nginx:alpine
    container_name: gitlab-sre-observe-nginx
    ports:
      - "12443:443"
    volumes:
      - ./observability/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/certs:/etc/nginx/certs:ro
    depends_on:
      - grafana
      - prometheus
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # EVENT PLANE - Redpanda (Kafka-compatible)
  # =========================================================================
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:latest
    container_name: gitlab-sre-redpanda
    command:
      - redpanda
      - start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
      - --rpc-addr redpanda:33145
      - --advertise-rpc-addr redpanda:33145
      - --smp 1
      - --memory 1G
      - --mode dev-container
      - --default-log-level=warn
    ports:
      - "18081:18081"  # Schema Registry
      - "18082:18082"  # Pandaproxy (REST)
      - "19092:19092"  # Kafka API
      - "19644:9644"   # Admin API
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health | grep -E 'Healthy:.+true' || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # EVENT PLANE - Redpanda Console (UI)
  # =========================================================================
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: gitlab-sre-redpanda-console
    environment:
      - KAFKA_BROKERS=redpanda:9092
      - KAFKA_SCHEMAREGISTRY_ENABLED=true
      - KAFKA_SCHEMAREGISTRY_URLS=http://redpanda:8081
      - REDPANDA_ADMINAPI_ENABLED=true
      - REDPANDA_ADMINAPI_URLS=http://redpanda:9644
    ports:
      - "8080:8080"
    depends_on:
      redpanda:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # EVENT PLANE - nginx for events.ravenhelm.test
  # =========================================================================
  events-nginx:
    image: nginx:alpine
    container_name: gitlab-sre-events-nginx
    ports:
      - "13443:443"
    volumes:
      - ./redpanda/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/certs:/etc/nginx/certs:ro
    depends_on:
      - redpanda-console
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # ZERO TRUST - SPIRE Server (Workload Identity)
  # =========================================================================
  spire-server:
    image: ghcr.io/spiffe/spire-server:1.9.0
    container_name: gitlab-sre-spire-server
    command: ["-config", "/opt/spire/conf/server/server.conf"]
    volumes:
      - ./spire/server:/opt/spire/conf/server:ro
      - spire_server_data:/opt/spire/data
      - spire_server_run:/tmp/spire-server/private
    ports:
      - "8081:8081"  # SPIRE Server API
    healthcheck:
      test: ["CMD", "/opt/spire/bin/spire-server", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # ZERO TRUST - SPIRE Agent (Workload Attestation)
  # =========================================================================
  spire-agent:
    image: ghcr.io/spiffe/spire-agent:1.9.0
    container_name: gitlab-sre-spire-agent
    command: ["-config", "/opt/spire/conf/agent/agent.conf"]
    volumes:
      - ./spire/agent:/opt/spire/conf/agent:ro
      - spire_agent_data:/opt/spire/data
      - spire_server_run:/tmp/spire-server/private:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For Docker workload attestation
    depends_on:
      spire-server:
        condition: service_healthy
    pid: "host"  # Required for process attestation
    healthcheck:
      test: ["CMD", "/opt/spire/bin/spire-agent", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # HLIÐSKJÁLF - Odin's High Seat (Control Plane)
  # From here, observe all Nine Realms
  # =========================================================================
  hlidskjalf:
    build:
      context: ./hlidskjalf
      dockerfile: Dockerfile
    container_name: gitlab-sre-hlidskjalf
    labels:
      - "ravenhelm.project=hlidskjalf"
      - "ravenhelm.service=api"
      - "ravenhelm.workload=control-plane"
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/hlidskjalf
      - REDIS_URL=redis://redis:6379/2
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - SPIRE_AGENT_SOCKET=/tmp/spire-agent/public/api.sock
      - TRUST_DOMAIN=ravenhelm.local
      # The Norns - AI Agent
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - NORNS_MODEL=gpt-4o
      - LANGFUSE_HOST=http://langfuse-server:3000
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
    volumes:
      - ./hlidskjalf/src:/app/src:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "8900:8900"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8900/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - gitlab-network

  hlidskjalf-ui:
    build:
      context: ./hlidskjalf/ui
      dockerfile: Dockerfile
    container_name: gitlab-sre-hlidskjalf-ui
    labels:
      - "ravenhelm.project=hlidskjalf"
      - "ravenhelm.service=ui"
      - "ravenhelm.workload=control-plane"
    environment:
      - NEXT_PUBLIC_API_URL=https://hlidskjalf-api.ravenhelm.test
    ports:
      - "3900:3900"
    depends_on:
      - hlidskjalf
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # SHARED DATABASE - PostgreSQL + pgvector (Muninn's canonical truth)
  # =========================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: gitlab-sre-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # HUGINN'S WIND - NATS JetStream (fast, low-latency state transport)
  # =========================================================================
  nats:
    image: nats:latest
    container_name: gitlab-sre-nats
    command: 
      - "--jetstream"
      - "--store_dir=/data"
      - "--http_port=8222"
      - "--port=4222"
    ports:
      - "4222:4222"   # Client connections
      - "8222:8222"   # HTTP monitoring
    volumes:
      - nats_data:/data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # SHARED CACHE - Redis for platform services
  # =========================================================================
  redis:
    image: redis:7-alpine
    container_name: gitlab-sre-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # LLM OBSERVABILITY - LangFuse (LangGraph/LangChain tracing)
  # =========================================================================
  langfuse:
    image: langfuse/langfuse:latest
    container_name: gitlab-sre-langfuse
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/langfuse
      - NEXTAUTH_SECRET=ravenhelm-langfuse-secret-change-in-prod
      - NEXTAUTH_URL=https://langfuse.observe.ravenhelm.test
      - SALT=ravenhelm-salt-change-in-prod
      - ENCRYPTION_KEY=0000000000000000000000000000000000000000000000000000000000000000
      - TELEMETRY_ENABLED=false
      - LANGFUSE_ENABLE_EXPERIMENTAL_FEATURES=true
    ports:
      - "3001:3000"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # LLM OBSERVABILITY - Phoenix (Arize) for embeddings & RAG debugging
  # =========================================================================
  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: gitlab-sre-phoenix
    environment:
      - PHOENIX_WORKING_DIR=/data
    volumes:
      - phoenix_data:/data
    ports:
      - "6006:6006"
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # SECRETS - OpenBao (Vault fork)
  # =========================================================================
  openbao:
    image: quay.io/openbao/openbao:latest
    container_name: gitlab-sre-openbao
    entrypoint: /bin/sh
    command:
      - -c
      - |
        chown -R openbao:openbao /openbao/data
        exec su-exec openbao bao server -config=/openbao/config
    user: "0"
    cap_add:
      - IPC_LOCK
    environment:
      - BAO_ADDR=http://0.0.0.0:8200
      - BAO_API_ADDR=http://0.0.0.0:8200
    volumes:
      - ./openbao/config:/openbao/config:ro
      - openbao_data:/openbao/data
    ports:
      - "8200:8200"
    healthcheck:
      test: ["CMD", "bao", "status", "-address=http://127.0.0.1:8200"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # SECRETS - nginx for vault.ravenhelm.test
  # =========================================================================
  vault-nginx:
    image: nginx:alpine
    container_name: gitlab-sre-vault-nginx
    ports:
      - "14443:443"
    volumes:
      - ./openbao/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/certs:/etc/nginx/certs:ro
    depends_on:
      - openbao
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # AUTOMATION - n8n (Workflow Automation)
  # =========================================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: gitlab-sre-n8n
    environment:
      - N8N_HOST=n8n.ravenhelm.test
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.ravenhelm.test/
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=postgres
      - DB_POSTGRESDB_PASSWORD=postgres
      - N8N_ENCRYPTION_KEY=ravenhelm-n8n-encryption-key
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=168
    volumes:
      - n8n_data:/home/node/.n8n
    ports:
      - "5678:5678"
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # ╔═══════════════════════════════════════════════════════════════════════╗
  # ║                 RAG PIPELINE — Muninn's Knowledge Engine              ║
  # ╚═══════════════════════════════════════════════════════════════════════╝
  # =========================================================================

  # =========================================================================
  # VECTOR DB - Weaviate (Hybrid Search, BM25 + Vector)
  # =========================================================================
  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:latest
    container_name: gitlab-sre-weaviate
    command:
      - --host
      - 0.0.0.0
      - --port
      - '8084'
      - --scheme
      - http
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      ENABLE_MODULES: 'text2vec-transformers,reranker-transformers'
      TRANSFORMERS_INFERENCE_API: 'http://embeddings:8085'
      RERANKER_INFERENCE_API: 'http://reranker:8086'
      CLUSTER_HOSTNAME: 'weaviate'
    volumes:
      - weaviate_data:/var/lib/weaviate
    ports:
      - "8084:8084"  # Weaviate API
    depends_on:
      - embeddings
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8084/v1/.well-known/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # EMBEDDINGS - Sentence Transformers via HuggingFace TEI
  # https://huggingface.co/sentence-transformers
  # =========================================================================
  embeddings:
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.5
    container_name: gitlab-sre-embeddings
    command:
      - --model-id
      - sentence-transformers/all-MiniLM-L6-v2
      - --port
      - '8085'
    volumes:
      - embeddings_cache:/data
    ports:
      - "8085:8085"  # TEI Embeddings API
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8085/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # Model download can take time
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # RERANKER - Cross-Encoder for result reranking
  # =========================================================================
  reranker:
    image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.5
    container_name: gitlab-sre-reranker
    command:
      - --model-id
      - BAAI/bge-reranker-base
      - --port
      - '8086'
    volumes:
      - reranker_cache:/data
    ports:
      - "8086:8086"  # Reranker API
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # DOCLING - Document Processing (IBM Research)
  # Parses PDF, DOCX, PPTX, HTML into structured markdown
  # =========================================================================
  docling:
    image: ds4sd/docling-serve:latest
    container_name: gitlab-sre-docling
    ports:
      - "8087:5000"  # Docling API
    volumes:
      - docling_cache:/root/.cache
    environment:
      - DOCLING_CACHE_DIR=/root/.cache
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # ╔═══════════════════════════════════════════════════════════════════════╗
  # ║            GRAPH DATABASES — The Roots of Yggdrasil                   ║
  # ╚═══════════════════════════════════════════════════════════════════════╝
  # =========================================================================

  # =========================================================================
  # GRAPH DB - Memgraph (In-memory, Cypher-compatible)
  # =========================================================================
  memgraph:
    image: memgraph/memgraph-platform:latest
    container_name: gitlab-sre-memgraph
    ports:
      - "7687:7687"   # Bolt protocol
      - "7444:7444"   # Memgraph Lab
      - "3010:3000"   # Memgraph Lab UI
    volumes:
      - memgraph_data:/var/lib/memgraph
      - memgraph_log:/var/log/memgraph
    environment:
      - MEMGRAPH_USER=memgraph
      - MEMGRAPH_PASSWORD=ravenhelm
    healthcheck:
      test: ["CMD", "echo", "RETURN 1;", "|", "mgconsole", "--host", "127.0.0.1", "--port", "7687"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - gitlab-network

  # =========================================================================
  # GRAPH DB - Neo4j (Enterprise-grade, APOC/GDS plugins)
  # =========================================================================
  neo4j:
    image: neo4j:5-community
    container_name: gitlab-sre-neo4j
    ports:
      - "7475:7474"   # HTTP (browser) - offset to avoid memgraph conflict
      - "7688:7687"   # Bolt protocol - offset to avoid memgraph conflict
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/ravenhelm
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    networks:
      - gitlab-network

volumes:
  gitlab_config:
  gitlab_logs:
  gitlab_data:
  gitlab_runner_config:
  localstack_data:
  spire_server_data:
  spire_server_run:
  spire_agent_data:
  postgres_data:
  redis_data:
  nats_data:
  prometheus_data:
  loki_data:
  tempo_data:
  grafana_data:
  alertmanager_data:
  redpanda_data:
  openbao_data:
  phoenix_data:
  n8n_data:
  weaviate_data:
  embeddings_cache:
  reranker_cache:
  docling_cache:
  memgraph_data:
  memgraph_log:
  neo4j_data:
  neo4j_logs:
  neo4j_plugins:

networks:
  gitlab-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.88.0.0/16
