# Traefik Edge Proxy for Ravenhelm Platform
# ==========================================
# Replaces nginx with Traefik for autodiscovery architecture

services:
  traefik:
    image: traefik:v3.1
    container_name: ravenhelm-traefik
    restart: unless-stopped
    
    ports:
      # HTTP -> HTTPS redirect
      - "80:80"
      # Main HTTPS entry point for all *.ravenhelm.test
      - "443:443"
      # Traefik dashboard
      - "8888:8080"
      
      # LiveKit WebRTC ports (will be handled by labels in service config)
      - "7885:7885"
      - "7886:7886"
      - "7887-7897:7887-7897/udp"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/etc/traefik/traefik.yml:ro
      - ./dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ./config/certs:/certs:ro

    environment:
      - TRAEFIK_LOG_LEVEL=INFO

    networks:
      - edge
      - platform_net
      - gitlab_net
      - saaa_net
      - m2c_net
      - tinycrm_net
      - ravenhelm

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`proxy.ravenhelm.test`)"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=secure-headers@file"

    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  edge:
    name: edge
    external: true
  platform_net:
    name: platform_net
    external: true
  gitlab_net:
    name: gitlab_net
    external: true
  saaa_net:
    name: saaa_net
    external: true
  m2c_net:
    name: m2c_net
    external: true
  tinycrm_net:
    name: tinycrm_net
    external: true
  ravenhelm:
    name: ravenhelm-network
    external: true