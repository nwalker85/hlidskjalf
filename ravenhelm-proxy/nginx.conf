# =============================================================================
# RAVENHELM PROXY — The Bifröst Bridge
# =============================================================================
# Routes *.ravenhelm.test to all services across the Nine Realms.
# From Hliðskjálf, Odin sees all — this proxy is his eye.
#
# Port Allocation Strategy:
#   Platform APIs:      8000-8099
#   Personal APIs:      8100-8199 (nwalker85/)
#   Work APIs:          8200-8299 (Quant/)
#   Platform UIs:       3000-3099
#   Personal UIs:       3100-3199
#   Work UIs:           3200-3299
# =============================================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    client_max_body_size 100M;

    # WebSocket upgrade map
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # SSL Configuration (shared CA for all *.ravenhelm.test)
    ssl_certificate /etc/nginx/certs/server.crt;
    ssl_certificate_key /etc/nginx/certs/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;

    # =========================================================================
    # HTTP → HTTPS REDIRECT
    # =========================================================================
    server {
        listen 80 default_server;
        server_name _;
        return 301 https://$host$request_uri;
    }

    # =========================================================================
    # ╔═══════════════════════════════════════════════════════════════════════╗
    # ║                    VANAHEIM — SHARED PLATFORM SERVICES                ║
    # ╚═══════════════════════════════════════════════════════════════════════╝
    # =========================================================================

    # ─────────────────────────────────────────────────────────────────────────
    # HLIÐSKJÁLF — Odin's High Seat (Control Plane Dashboard)
    # hlidskjalf.ravenhelm.test (UI) → localhost:3002
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name hlidskjalf.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:3002;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # HLIÐSKJÁLF API — Platform Control Plane
    # hlidskjalf-api.ravenhelm.test → localhost:8000
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name hlidskjalf-api.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:8000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # NORNS — LangGraph API (The Three Sisters)
    # norns.ravenhelm.test → localhost:2024
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name norns.ravenhelm.test langgraph.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:2024;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;  # Long timeout for agent operations
            proxy_buffering off;       # SSE streaming support
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # OLLAMA — Local LLM API
    # ollama.ravenhelm.test → localhost:11434
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name ollama.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:11434;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 600s;  # LLM generation can be slow
            proxy_buffering off;
            client_max_body_size 500M;  # Large model uploads
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # OBSERVABILITY — The Eye of Odin
    # *.observe.ravenhelm.test → various
    # ─────────────────────────────────────────────────────────────────────────
    
    # Grafana (grafana.observe.ravenhelm.test → localhost:3000)
    server {
        listen 443 ssl;
        http2 on;
        server_name grafana.observe.ravenhelm.test observe.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # Prometheus (prometheus.observe.ravenhelm.test → localhost:9090)
    server {
        listen 443 ssl;
        http2 on;
        server_name prometheus.observe.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:9090;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Alertmanager (alertmanager.observe.ravenhelm.test → localhost:9093)
    server {
        listen 443 ssl;
        http2 on;
        server_name alertmanager.observe.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:9093;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Tempo (tempo.observe.ravenhelm.test → localhost:3200)
    server {
        listen 443 ssl;
        http2 on;
        server_name tempo.observe.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:3200;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # LangFuse (langfuse.observe.ravenhelm.test → localhost:3001)
    server {
        listen 443 ssl;
        http2 on;
        server_name langfuse.observe.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:3001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # Phoenix (phoenix.observe.ravenhelm.test → localhost:6006)
    server {
        listen 443 ssl;
        http2 on;
        server_name phoenix.observe.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:6006;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # VAULT (OpenBao) — vault.ravenhelm.test → localhost:8200
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name vault.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:8200;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # LOCALSTACK — localstack.ravenhelm.test → localhost:4566
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name localstack.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:4566;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }
    

    # ─────────────────────────────────────────────────────────────────────────
    # REDPANDA CONSOLE — events.ravenhelm.test → localhost:8080
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name events.ravenhelm.test redpanda.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:8080;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # N8N — Workflow Automation
    # n8n.ravenhelm.test → localhost:5678
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name n8n.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:5678;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # =========================================================================
    # ╔═══════════════════════════════════════════════════════════════════════╗
    # ║            RAG PIPELINE — Muninn's Knowledge Engine                   ║
    # ╚═══════════════════════════════════════════════════════════════════════╝
    # =========================================================================

    # ─────────────────────────────────────────────────────────────────────────
    # WEAVIATE — Vector Database (Hybrid Search)
    # weaviate.ravenhelm.test → localhost:8084
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name weaviate.ravenhelm.test vectors.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:8084;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
            proxy_buffering off;
            client_max_body_size 500M;  # Large batch imports
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # EMBEDDINGS — Sentence Transformers (HuggingFace TEI)
    # embeddings.ravenhelm.test → localhost:8085
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name embeddings.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:8085;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 120s;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # RERANKER — Cross-Encoder Reranking
    # reranker.ravenhelm.test → localhost:8086
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name reranker.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:8086;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 120s;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # DOCLING — Document Processing (IBM Research)
    # docling.ravenhelm.test → localhost:8087
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name docling.ravenhelm.test docs.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:8087;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 600s;  # Document parsing can be slow
            client_max_body_size 100M;  # Large documents
        }
    }

    # =========================================================================
    # ╔═══════════════════════════════════════════════════════════════════════╗
    # ║               GRAPH DATABASES — The Roots of Yggdrasil                ║
    # ╚═══════════════════════════════════════════════════════════════════════╝
    # =========================================================================

    # ─────────────────────────────────────────────────────────────────────────
    # MEMGRAPH LAB — In-memory Graph Database UI
    # memgraph.ravenhelm.test → localhost:3010
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name memgraph.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:3010;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # NEO4J — Enterprise Graph Database Browser
    # neo4j.ravenhelm.test → localhost:7475
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name neo4j.ravenhelm.test;

        location / {
            proxy_pass http://host.docker.internal:7475;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }

    # =========================================================================
    # ╔═══════════════════════════════════════════════════════════════════════╗
    # ║                 MIDGARD — PERSONAL PROJECTS (nwalker85/)              ║
    # ╚═══════════════════════════════════════════════════════════════════════╝
    # =========================================================================

    # ─────────────────────────────────────────────────────────────────────────
    # JARVIS — Personal AI Assistant v1
    # jarvis.ravenhelm.test → API:8101, UI:3101
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name jarvis.ravenhelm.test;

        location /api {
            proxy_pass http://host.docker.internal:8101;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        location / {
            proxy_pass http://host.docker.internal:3101;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # MYJARVIS — Personal AI Assistant v2 (Voice)
    # myjarvis.ravenhelm.test → API:8102, UI:3102
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name myjarvis.ravenhelm.test;

        location /api {
            proxy_pass http://host.docker.internal:8102;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        location / {
            proxy_pass http://host.docker.internal:3102;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # =========================================================================
    # ╔═══════════════════════════════════════════════════════════════════════╗
    # ║                   ALFHEIM — WORK PROJECTS (Quant/)                    ║
    # ╚═══════════════════════════════════════════════════════════════════════╝
    # =========================================================================

    # ─────────────────────────────────────────────────────────────────────────
    # AGENTSWARM (SAAA) — Voice AI Platform
    # saaa.ravenhelm.test, agentcrucible.ravenhelm.test → API:8201, UI:3201
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name saaa.ravenhelm.test agentcrucible.ravenhelm.test *.saaa.ravenhelm.test;

        # API routes
        location /api {
            proxy_pass http://host.docker.internal:8201;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        # WebSocket for LiveKit
        location /livekit {
            proxy_pass http://host.docker.internal:7880;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_read_timeout 3600s;
        }

        # Frontend
        location / {
            proxy_pass http://host.docker.internal:3201;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # AGENTFOUNDRY — Agent Builder Platform
    # foundry.ravenhelm.test → API:8202, UI:3202
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name foundry.ravenhelm.test agentfoundry.ravenhelm.test;

        location /api {
            proxy_pass http://host.docker.internal:8202;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        location / {
            proxy_pass http://host.docker.internal:3202;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # MYTINYCRM — CRM Demo Application
    # tinycrm.ravenhelm.test → API:8203, UI:3203
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name tinycrm.ravenhelm.test;

        location /api {
            proxy_pass http://host.docker.internal:8203;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://host.docker.internal:3203;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # LIVEKIT DEMO — Voice Agent Testing
    # livekit-demo.ravenhelm.test → API:8204, UI:3204
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name livekit-demo.ravenhelm.test livekit.ravenhelm.test;

        location /api {
            proxy_pass http://host.docker.internal:8204;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 300s;
        }

        location / {
            proxy_pass http://host.docker.internal:3204;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_read_timeout 3600s;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # M2C DEMO — M2C Demo Application
    # m2c.ravenhelm.test → API:8205, UI:3205
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name m2c.ravenhelm.test;

        location /api {
            proxy_pass http://host.docker.internal:8205;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://host.docker.internal:3205;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }

    # ─────────────────────────────────────────────────────────────────────────
    # JIRA INTERPRETER — Jira Integration Tool
    # jira.ravenhelm.test → API:8206, UI:3206
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 443 ssl;
        http2 on;
        server_name jira.ravenhelm.test;

        location /api {
            proxy_pass http://host.docker.internal:8206;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://host.docker.internal:3206;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }

    # =========================================================================
    # ╔═══════════════════════════════════════════════════════════════════════╗
    # ║                        DEFAULT — CATCH ALL                            ║
    # ╚═══════════════════════════════════════════════════════════════════════╝
    # =========================================================================
    server {
        listen 443 ssl default_server;
        server_name *.ravenhelm.test ravenhelm.test;

        location / {
            default_type application/json;
            return 404 '{"error": "Project not found in the Nine Realms", "hint": "Register this domain in Hliðskjálf", "domains": {"platform": "hlidskjalf.ravenhelm.test", "observability": "grafana.observe.ravenhelm.test"}}';
        }
    }
}

# =============================================================================
# STREAM — TCP/UDP Proxying (WebRTC, LiveKit)
# =============================================================================
stream {
    log_format stream_main '$remote_addr [$time_local] '
                          '$protocol $status $bytes_sent $bytes_received '
                          '$session_time';

    access_log /var/log/nginx/stream_access.log stream_main;

    # ─────────────────────────────────────────────────────────────────────────
    # LiveKit WebRTC Server (TCP)
    # ─────────────────────────────────────────────────────────────────────────
    server {
        listen 7880;
        proxy_pass host.docker.internal:7880;
        proxy_connect_timeout 10s;
        proxy_timeout 3600s;
    }

    # TURN Server (UDP)
    server {
        listen 3478 udp;
        proxy_pass host.docker.internal:3478;
        proxy_timeout 60s;
    }

    # ─────────────────────────────────────────────────────────────────────────
    # LiveKit UDP Media Ports (50000-50010 range)
    # ─────────────────────────────────────────────────────────────────────────
    server { listen 50000 udp; proxy_pass host.docker.internal:50000; proxy_timeout 60s; }
    server { listen 50001 udp; proxy_pass host.docker.internal:50001; proxy_timeout 60s; }
    server { listen 50002 udp; proxy_pass host.docker.internal:50002; proxy_timeout 60s; }
    server { listen 50003 udp; proxy_pass host.docker.internal:50003; proxy_timeout 60s; }
    server { listen 50004 udp; proxy_pass host.docker.internal:50004; proxy_timeout 60s; }
    server { listen 50005 udp; proxy_pass host.docker.internal:50005; proxy_timeout 60s; }
    server { listen 50006 udp; proxy_pass host.docker.internal:50006; proxy_timeout 60s; }
    server { listen 50007 udp; proxy_pass host.docker.internal:50007; proxy_timeout 60s; }
    server { listen 50008 udp; proxy_pass host.docker.internal:50008; proxy_timeout 60s; }
    server { listen 50009 udp; proxy_pass host.docker.internal:50009; proxy_timeout 60s; }
    server { listen 50010 udp; proxy_pass host.docker.internal:50010; proxy_timeout 60s; }
}
