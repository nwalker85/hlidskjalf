# Ravenhelm Platform CI/CD Pipeline
# ===================================
# Full lifecycle: Build ‚Üí Test ‚Üí Deploy ‚Üí Monitor

stages:
  - validate
  - build
  - test
  - security
  - deploy-dev
  - integration-test
  - deploy-staging
  - acceptance-test
  - deploy-prod
  - post-deploy

variables:
  # Terraform
  TF_ROOT: ${CI_PROJECT_DIR}/terraform
  TF_STATE_NAME: ${CI_ENVIRONMENT_NAME}
  # Docker
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_TLS_VERIFY: 1
  DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
  # App
  APP_NAME: ${CI_PROJECT_NAME}
  REGISTRY: ${CI_REGISTRY}/${CI_PROJECT_PATH}

# Include modular CI configurations
include:
  - local: '/gitlab-ci/terraform.yml'
  - local: '/gitlab-ci/docker.yml'
  - local: '/gitlab-ci/security.yml'
  - local: '/gitlab-ci/deploy.yml'
  - local: '/gitlab-ci/monitoring.yml'

# ============================================================================
# VALIDATE STAGE
# ============================================================================
validate:terraform:
  stage: validate
  image: hashicorp/terraform:1.6
  script:
    - cd ${TF_ROOT}
    - terraform init -backend=false
    - terraform validate
    - terraform fmt -check -recursive
  rules:
    - changes:
        - terraform/**/*

validate:docker:
  stage: validate
  image: hadolint/hadolint:latest-alpine
  script:
    - find . -name "Dockerfile*" -exec hadolint {} \;
  allow_failure: true
  rules:
    - exists:
        - "**/Dockerfile*"

# ============================================================================
# BUILD STAGE
# ============================================================================
build:docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - docker build -t ${REGISTRY}:${CI_COMMIT_SHORT_SHA} .
    - docker build -t ${REGISTRY}:latest .
    - docker push ${REGISTRY}:${CI_COMMIT_SHORT_SHA}
    - docker push ${REGISTRY}:latest
  rules:
    - exists:
        - Dockerfile

# ============================================================================
# TEST STAGE
# ============================================================================
test:unit:
  stage: test
  image: python:3.13-slim
  script:
    - pip install -r requirements.txt -r requirements-dev.txt
    - pytest tests/unit --cov=src --cov-report=xml
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  rules:
    - exists:
        - pytest.ini
        - pyproject.toml

test:integration:
  stage: integration-test
  image: python:3.13-slim
  services:
    - name: postgres:16
      alias: db
    - name: redis:7
      alias: cache
  variables:
    POSTGRES_DB: test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    DATABASE_URL: postgresql://test:test@db:5432/test
    REDIS_URL: redis://cache:6379
  script:
    - pip install -r requirements.txt -r requirements-dev.txt
    - pytest tests/integration -v
  rules:
    - exists:
        - tests/integration/**/*

# ============================================================================
# SECURITY STAGE
# ============================================================================
security:sast:
  stage: security
  image: semgrep/semgrep:latest
  script:
    - semgrep scan --config auto --json --output sast-report.json .
  artifacts:
    reports:
      sast: sast-report.json
  allow_failure: true

security:dependency:
  stage: security
  image: python:3.13-slim
  script:
    - pip install safety
    - safety check -r requirements.txt --json > dependency-report.json || true
  artifacts:
    paths:
      - dependency-report.json
  allow_failure: true

security:container:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy image --exit-code 0 --severity HIGH,CRITICAL ${REGISTRY}:${CI_COMMIT_SHORT_SHA}
  rules:
    - exists:
        - Dockerfile
  allow_failure: true

# ============================================================================
# DEPLOY DEV
# ============================================================================
deploy:dev:
  stage: deploy-dev
  image: hashicorp/terraform:1.6
  environment:
    name: dev
    url: https://dev.${CI_PROJECT_NAME}.ravenhelm.test
    on_stop: destroy:dev
  variables:
    TF_VAR_environment: dev
    TF_VAR_app_version: ${CI_COMMIT_SHORT_SHA}
  before_script:
    - cd ${TF_ROOT}/environments/dev
    - terraform init
  script:
    - terraform plan -out=plan.tfplan
    - terraform apply -auto-approve plan.tfplan
  artifacts:
    paths:
      - ${TF_ROOT}/environments/dev/terraform.tfstate
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

destroy:dev:
  stage: deploy-dev
  image: hashicorp/terraform:1.6
  environment:
    name: dev
    action: stop
  variables:
    TF_VAR_environment: dev
  script:
    - cd ${TF_ROOT}/environments/dev
    - terraform init
    - terraform destroy -auto-approve
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

# ============================================================================
# DEPLOY STAGING
# ============================================================================
deploy:staging:
  stage: deploy-staging
  image: hashicorp/terraform:1.6
  environment:
    name: staging
    url: https://staging.${CI_PROJECT_NAME}.ravenhelm.test
  variables:
    TF_VAR_environment: staging
    TF_VAR_app_version: ${CI_COMMIT_SHORT_SHA}
  before_script:
    - cd ${TF_ROOT}/environments/staging
    - terraform init
  script:
    - terraform plan -out=plan.tfplan
    - terraform apply -auto-approve plan.tfplan
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - deploy:dev
    - test:integration

# ============================================================================
# ACCEPTANCE TESTS
# ============================================================================
acceptance:test:
  stage: acceptance-test
  image: cypress/included:latest
  script:
    - npx cypress run --config baseUrl=https://staging.${CI_PROJECT_NAME}.ravenhelm.test
  artifacts:
    paths:
      - cypress/screenshots
      - cypress/videos
    when: on_failure
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      exists:
        - cypress.config.js
  needs:
    - deploy:staging

# ============================================================================
# DEPLOY PRODUCTION
# ============================================================================
deploy:prod:
  stage: deploy-prod
  image: hashicorp/terraform:1.6
  environment:
    name: production
    url: https://${CI_PROJECT_NAME}.ravenhelm.co
  variables:
    TF_VAR_environment: production
    TF_VAR_app_version: ${CI_COMMIT_SHORT_SHA}
  before_script:
    - cd ${TF_ROOT}/environments/prod
    - terraform init
  script:
    - terraform plan -out=plan.tfplan
    - terraform apply -auto-approve plan.tfplan
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  needs:
    - acceptance:test

# ============================================================================
# POST-DEPLOY (Monitoring & Notifications)
# ============================================================================
post:smoke-test:
  stage: post-deploy
  image: curlimages/curl:latest
  script:
    - |
      for i in 1 2 3 4 5; do
        if curl -sf https://${CI_ENVIRONMENT_URL}/health; then
          echo "‚úÖ Health check passed"
          exit 0
        fi
        sleep 10
      done
      echo "‚ùå Health check failed"
      exit 1
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

post:notify:
  stage: post-deploy
  image: curlimages/curl:latest
  script:
    - |
      curl -X POST "${SLACK_WEBHOOK_URL}" \
        -H "Content-Type: application/json" \
        -d "{
          \"text\": \"üöÄ Deployed ${CI_PROJECT_NAME} v${CI_COMMIT_SHORT_SHA} to ${CI_ENVIRONMENT_NAME}\",
          \"attachments\": [{
            \"color\": \"good\",
            \"fields\": [
              {\"title\": \"Environment\", \"value\": \"${CI_ENVIRONMENT_NAME}\", \"short\": true},
              {\"title\": \"Pipeline\", \"value\": \"${CI_PIPELINE_URL}\", \"short\": true}
            ]
          }]
        }"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
  allow_failure: true

